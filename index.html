<!doctype html>
<!-- trigger rebuild -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workshop Attendance (Blockchain Demo)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 26px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    .muted { color:#666; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 14px 0; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    input, textarea, select { padding:10px; border-radius:10px; border:1px solid #ddd; width: 360px; max-width: 100%; }
    textarea { width: 740px; max-width: 100%; height: 90px; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; }
    button.primary { background:#111; color:#fff; }
    button.secondary { background:#eee; }
    .ok { color:#0a7; font-weight: 700; }
    .warn { color:#c60; font-weight: 700; }
    .err { color:#c00; font-weight: 700; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: top; text-align:left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .log { white-space: pre-wrap; background:#0b1020; color:#d9e2ff; padding: 12px; border-radius: 12px; min-height: 100px; }
    .badge { display:inline-block; padding:3px 8px; border-radius: 999px; background:#f3f3f3; }
  </style>
</head>
<body>
  <h1>Workshop Attendance (Blockchain Demo)</h1>
  <div class="muted">
    Network: <b>Sepolia</b> • Contract: <span class="mono" id="contractAddr"></span>
  </div>

	
  <div class="card">
    <h2>1) Connect Wallet</h2>
    <div class="row">
      <button class="primary" id="btnConnect">Connect MetaMask</button>
      <button class="secondary" id="btnSwitch">Switch to Sepolia</button>
    </div>
    <p>Status: <span id="status" class="warn">Not connected</span></p>
    <p>Account: <span id="account" class="mono">—</span></p>
    <p>Chain ID: <span id="chainId">—</span></p>
  </div>

  <div class="card">
    <h2>2) Register (On-chain)</h2>
    <p class="muted">
      Note: This is a public test network. Your name/comment will be visible on-chain.
      Keep comments short.
    </p>

    <div class="row">
      <div>
        <div class="muted">Full name & surname</div>
        <input id="fullName" placeholder="e.g., Alice Johnson" />
      </div>

      <div>
        <div class="muted">Rating (0 = worst, 5 = best)</div>
        <select id="rating">
          <option value="5">5</option><option value="4">4</option><option value="3">3</option>
          <option value="2">2</option><option value="1">1</option><option value="0">0</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">Comment (max ~280 chars)</div>
      <textarea id="comment" placeholder="Write a short comment about the workshop..."></textarea>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="btnRegister">Register</button>
      <span class="muted">One registration per wallet address.</span>
    </div>
  </div>

  <div class="card">
    <h2>3) Results (Read-only)</h2>
    <div class="row">
      <button class="secondary" id="btnLoad">Load Results</button>
      <span>Total: <span id="total" class="ok">—</span></span>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table id="resultsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Wallet</th>
            <th>Name</th>
            <th>Rating</th>
            <th>Comment</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Logs</h2>
    <div id="log" class="log"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script>
    // ====== CONFIG ======
    const CONTRACT_ADDRESS = "0x63906053621a02E3B4E15fdB0e03D7d929d3A487";
    const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7"; // 11155111
    const ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "fullName",
				"type": "string"
			},
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "register",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_workshopTitle",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "attendee",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			}
		],
		"name": "Registered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getEntry",
		"outputs": [
			{
				"internalType": "address",
				"name": "attendee",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "fullName",
				"type": "string"
			},
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasRegistered",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "organizer",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalRegistrations",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "workshopTitle",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
	];

    // ====== UI helpers ======
    const $ = (id) => document.getElementById(id);
    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      $("log").textContent = `[${ts}] ${msg}\n` + $("log").textContent;
    }

    $("contractAddr").textContent = CONTRACT_ADDRESS;

    let provider, signer, contractRO, contractRW;

    function requireMetaMask() {
      if (!window.ethereum) throw new Error("MetaMask not detected");
    }

    async function refresh() {
      if (!provider) return;
      const net = await provider.getNetwork();
      $("chainId").textContent = net.chainId.toString();

      const accounts = await provider.send("eth_accounts", []);
      if (accounts.length) {
        $("status").className = "ok";
        $("status").textContent = "Connected";
        $("account").textContent = accounts[0];
        signer = await provider.getSigner();
        contractRW = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      } else {
        $("status").className = "warn";
        $("status").textContent = "Not connected";
        $("account").textContent = "—";
        signer = null;
        contractRW = null;
      }
      contractRO = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
    }

    async function ensureSepolia() {
      const chainId = await window.ethereum.request({ method: "eth_chainId" });
      if (chainId !== SEPOLIA_CHAIN_ID_HEX) {
        $("status").className = "warn";
        $("status").textContent = "Wrong network (switch to Sepolia)";
        throw new Error("Wrong network. Please switch to Sepolia.");
      }
    }

    $("btnConnect").onclick = async () => {
      try {
        requireMetaMask();
        provider = new ethers.BrowserProvider(window.ethereum);
        log("Requesting wallet connection...");
        await provider.send("eth_requestAccounts", []);
        await refresh();
        log("Connected.");
      } catch (e) {
        log("ERROR: " + (e.message || e));
      }
    };

    $("btnSwitch").onclick = async () => {
      try {
        requireMetaMask();
        log("Switching to Sepolia...");
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: SEPOLIA_CHAIN_ID_HEX }]
        });
        if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
        await refresh();
        log("Switched to Sepolia.");
      } catch (e) {
        log("ERROR: " + (e.message || e));
      }
    };

    $("btnRegister").onclick = async () => {
      try {
        requireMetaMask();
        if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
        await refresh();
        await ensureSepolia();

        if (!contractRW) throw new Error("Please connect MetaMask first.");

        const fullName = $("fullName").value.trim();
        const rating = parseInt($("rating").value, 10);
        const comment = $("comment").value.trim();

        if (!fullName) throw new Error("Full name is required.");
        if (rating < 0 || rating > 5) throw new Error("Rating must be 0..5.");
        if (comment.length > 280) throw new Error("Comment too long (max 280).");

        const already = await contractRO.hasRegistered(await signer.getAddress());
        if (already) throw new Error("This wallet already registered.");

        log("Sending register() transaction... MetaMask will prompt.");
        const tx = await contractRW.register(fullName, rating, comment);
        log("Submitted: " + tx.hash);
        log("Waiting for confirmation...");

        const receipt = await tx.wait();
        log("Confirmed in block " + receipt.blockNumber);

        $("fullName").value = "";
        $("comment").value = "";

        // Refresh results count quickly
        const total = await contractRO.totalRegistrations();
        $("total").textContent = total.toString();
      } catch (e) {
        log("ERROR: " + (e.message || e));
      }
    };

    $("btnLoad").onclick = async () => {
      try {
        requireMetaMask();
        if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
        await refresh();
        await ensureSepolia();

        const total = await contractRO.totalRegistrations();
        $("total").textContent = total.toString();
        log("Loading " + total.toString() + " entries...");

        const tbody = $("resultsTable").querySelector("tbody");
        tbody.innerHTML = "";

        for (let i = 0; i < Number(total); i++) {
          const [attendee, name, rating, comment, ts] = await contractRO.getEntry(i);
          const date = new Date(Number(ts) * 1000).toLocaleString();

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="badge">${i}</span></td>
            <td class="mono">${attendee}</td>
            <td>${escapeHtml(name)}</td>
            <td><b>${rating}</b></td>
            <td>${escapeHtml(comment)}</td>
            <td>${date}</td>
          `;
          tbody.appendChild(tr);
        }

        log("Results loaded.");
      } catch (e) {
        log("ERROR: " + (e.message || e));
      }
    };

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    if (window.ethereum) {
      window.ethereum.on("accountsChanged", async () => { log("Account changed."); if (!provider) provider = new ethers.BrowserProvider(window.ethereum); await refresh(); });
      window.ethereum.on("chainChanged", async () => { log("Network changed."); if (!provider) provider = new ethers.BrowserProvider(window.ethereum); await refresh(); });
    }

    log("Tip: Switch MetaMask to Sepolia and ensure you have test ETH.");
  </script>
</body>
</html>
